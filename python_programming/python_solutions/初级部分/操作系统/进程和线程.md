# 操作系统

## 进程和线程

### 什么是进程

进程是系统进行资源分配和调度的一个 _独立单位_，也就是说进程是可以独立运行的一段程序。当进程激活时，操作系统就将系统的资源包括 CPU，内存和 I/O等分配给它，使它执行。

进程，简而言之，就是正在执行中的程序。一个或多个线程运行在进程的上下文中。

一个进程拥有以下资源：

- 一个计算机程序的可执行机器码镜像
- 内存（一部分虚拟内存），包括了：
    - 可执行的机器码
    - 与进程相关的数据（输入与输出）
    - 一个调用栈，用于跟踪子程序或其他事件的活动
    - 一个堆，用于存放进程运行时产生的中间计算数据
- 分配给这个进程的资源描述符，如：文件描述符等
- 一些安全属性，比如进程的拥有者和进程的权限信息
- 处理器状态信息（上下文），比如：寄存器内容和内存的物理地址信息
    - 当进程处于执行状态时，状态信息保存在寄存器里
    - 当进程处于其他状态时，状态信息保存在内存里。

操作系统把处于活动状态的进程信息保存在叫做进程控制块（process control blocks）的数据结构里。

在支持多线程或子进程的操作系统里，至少处理器状态信息是进程的每个线程都共享的。

#### 进程控制块

process control block，也叫 task controlling block，entry of the process table， task strcut， switchframe。

它是操作系统内核中的一种数据结构，用于存放特定进程的信息，以便内核对进程进行管理。PCB，是进程在操作系统中的表现形式。

进程控制块的角色

PCB 在进程管理中扮演了核心角色：

- 它们可以被绝大部分 os 应用获得或修改，包括：
    - 与进程调度相关的 os 应用
    - 获取内存和 I/O 资源的应用
    - 性能监控相关的应用
可以说， PCB 的集合定义了当前操作系统的状态。

进程控制块的结构

进程控制块的内容可主要分为以下三类：

1. 进程身份信息
2. 进程状态信息
3. 进程控制信息

一般通过创建和更新与进程有关的实体状态表，来表示这些信息，比如：memory tables，I/O device tables，file tables，process tables

进程身份信息，包含一个特殊的标识符（id），这一般是一个不变的整数值。这个 id 会在 os 的各种实体状态表中被引用，这可以确定某个进程使用了哪些资源。

进程状态信息，用于存放当进程被挂起后的状态，运行 os 可以重启进程并保证正确的执行。因此，一般包括：

- 通用寄存器的内容
- CPU 进程状态字
- 栈与帧的指针
在上下文切换时，内核暂停当前正执行的进程，将硬件寄存器中的值拷贝到 PCB，然后用新进程 PCB 的值更新硬件寄存器

进程控制信息，是 os 用来管理进程自身的，一般包括：

- 进程调度状态， 比如：ready，suspended，优先级。对于一个被挂起的进程，这个进程需要等待的事件的标识数据（id data）必须被记录
- 进程结构信息，比如：子进程的 id，与之相关的其他进程的 id
- IPC 信息，各种标志，信号和消息
- 进程的权限信息，是否允许获得某些系统资源
- 进程 id 信息
- 程序计数器，指向这个进程需要执行的下一条指令地址的指针
- CPU 寄存器 信息，CPU 的各种寄存器，这是进程可以恢复到执行状态所需要的
- CPU 调度信息，在调度过程中，进程使用的 CPU 时间
- 内存管理信息，page table 的信息，等
- 审计信息
- IO 状态信息，分配给进程的一系列 I/O 设备

进程控制块存放在内存中受保护的区域里。

#### 进程隔离

进程隔离是一系列不同的硬件和软件技术，用来保护每个进程不受其他进程的干扰（阻止进程 A 执行写操作到进程 B）

进程隔离可以通过虚拟地址空间实现（virtual address space），进程 A 的地址空间不同于进程 B 的地址空间。


## 什么是线程

线程是操作系统可进行独立调度管理的 _最小可执行单位_。线程是进程的一部分，多个线程可共存于一个进程中，并发地执行，并共享进程的资源，如内存，可执行的机器码，还有变量的值。

线程是进程的一部分，多个线程可共存于一个进程中，并发地执行，并共享进程的系统资源（如虚拟地址空间，文件描述符和信号处理等），线程自己基本上不拥有系统资源，但各个线程有各自的调用栈（call stack），自己的寄存器环境（register context），自己的线程本地存储（thread-local storage）。

由于线程共享地址空间，使用多线程编程时要 _避免竞争条件发生_。


### 线程控制块

它是操作系统内核中的一种数据结构，用于存放特定线程的信息，以便内核对线程进行管理。TCB (Thread Control Block)，是进程在操作系统中的表现形式。

线程控制块中一般包含以下信息：

- 线程标识符（id），每个新线程都有一个独一无二的 id
- 栈指针，指向进程中这个线程的栈
- 程序计数器
- 线程的状态，runnig，ready，waiting，start，done
- 线程的寄存器内容
-  指向所属进程 PCB (Process Control Block) 的指针


## 进程与线程的区别

- 状态信息：进程比线程携带了更多的状态信息，而属于同一个进程的多个线程共享进程的状态（内存，其他资源）
- 地址空间：进程有独立的地址空间，不同的进程间相互隔离；而属于同一个进程的多个线程则共享地址空间
- 通信：进程之间通信只能使用由操作系统提供的 IPC 机制，线程间可以直接读写进程数据段（如全局变量）来进行通信——需要进程同步和互斥手段的辅助，以保证数据的一致性
- 调度和切换：进程切换时耗费资源较多，线程上下文切换比进程上下文切换要快得多

