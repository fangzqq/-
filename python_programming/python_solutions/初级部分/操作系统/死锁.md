# 操作系统

## 死锁

### 什么是死锁

在线程间共享多个资源时，如果两个线程分别占用一部分资源并且同时等待对方的资源时，这两个线程将循环等待对方占有的资源而无限期地僵持下去，这种现象就被称为死锁。产生死锁的根本原因是 _系统资源有限且程序推进顺序不当_ 导致的。

系统发生死锁时不仅会浪费大量的系统资源，甚至会导致系统的崩溃。

### 产生死锁的原因

- 系统资源不足
- 进程推进顺序不当
- 资源分配不当

### 死锁出现的必要条件

出现死锁需要同时满足以下条件：

1. 互斥条件，即是某个资源在一段时间内只能被一个线程使用，不能同时被两个或两个以上的线程占有。这是 _由资源的属性决定的_。
2. 不可抢占条件，进程已获得的资源，在未使用完之前，不能被强行剥夺，而只能由该资源的占有者自行释放
3. 请求与保持条件，一个进程因请求其他资源而阻塞时，对已获得的资源保持占有而不释放
4. 循环等待条件，若干进程之间形成一种头尾相接的循环等待资源关系


### 解决死锁的方法

只要破坏死锁发生的四个必要条件中的任何一个条件，死锁就不会发生。解决死锁的方法可分为：
- 死锁的预防
- 死锁的避免
- 死锁的检测与恢复

### 死锁的预防

基本思想是要求进程在申请资源时遵循某种协议，对进程申请资源的活动加以限制，从而打破产生死锁的四个必要条件中的一个或几个，保证系统不会进入死锁状态。

例如，要求用户申请资源时一次性申请所需要的全部资源，这就破坏了 _请求和保持条件_；将资源分层，得到上一层资源后，才能够申请下一层资源，它破坏了 _循环等待条件_。

预防死锁通常会降低系统的效率。

### 死锁的避免

基本思想是不限制进程申请资源的命令，而是对进程所发出的每一个申请资源命令进行 _动态地检查_，并根据检查结果决定是否进行资源分配，在资源分配过程中若预测到有发生死锁的可能性时，则加以避免：

- 如果一个进程当前请求的资源会导致死锁，系统拒绝启动该进程
- 如果一个资源的分配会导致下一步的死锁，系统就拒绝本次的分配

这种方法的关键是 _确定资源分配的安全性_。死锁避免算法的执行会增加系统的开销。


### 死锁的检测与恢复

基本思想是系统为进程分配资源时，不采取任何限制性措施，但是 _提供了检测和解脱死锁的手段_，也即是系统能发现死锁并从死锁状态中恢复出来（将某进程所拥有的资源强行回收，分配给其他进程）

